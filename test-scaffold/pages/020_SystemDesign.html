<html>
    <head>
        {{#each SiteProperties.StyleSheets}}
        <link rel="stylesheet" href="{{url}}">
        {{/each}}
    </head>
     <body>
                 
      <h1>System Design</h1>
      <p>The SSUI Advanced Audit application was originally created to support the auditing of crate bills for certain customers. It has since been expanded to support the auditing of freight bills. The primary use case was for the &ldquo;Agilent&rdquo; customer, who want to be able to have a lot of flexibility in how they rated charges based on several different factors such as airline, origin airport, destination airport, and other factors. The AA rule system is not very opinionated in how the rules are structured or built. Users have the freedom to define rules to as simple or as complex as they choose.</p>
      <h1>Architecture</h1>
      <p>The Advanced Audit application is comprised of several different components.</p>
      <h2>Web API for data access</h2>
      <p>The web API for AA consists of sever different endpoints for retrieving data and modifying data. The web UI front-end uses this API exclusively for accessing data. All API methods are REST based, and can accept and send either JSON or XML requests. The production API web address is: <a href="http://api.audit.ssui.local">http://api.audit.ssui.local</a> (will vary for the other environments)</p>
      <h2>Web UI</h2>
      <p>The web based user interface is built using the Angular 4 frameworks. The application is what is called a &ldquo;single page application&rdquo; or SPA. The production management UI web address is <a href="http://manage.audit.ssui.local">http://manage.audit.ssui.local</a> .</p>
      <h2>Service Bus - Rabbit MQ</h2>
      <p>The service bus allows for service de-coupling and retrying failed message. When SSUI Prime sends a freight bill audit request to the SAA system, the message is immediately put on to the bus and queue for processing and a success response is returned to the caller. This submission is very fast (~175ms), and should very rarely fail. The message handler can process up to 16 messages (configurable) in parallel. Initial stress testing show that 1000 audit requests (each audit taking ~8 sec) can be completed in under 600 seconds (as opposed to 8000 seconds if processed serially)</p>
      <p>The underlying queues can be viewed and modified using the Rabbit MQ web management portal. (http://manage.audit.ssui.local:15672)</p>
      <h3>Poison Messages</h3>
      <p>When a message fails to be processed for some reason (due to the data being bad, there is a bug in the application, or some other transient connectivity issue), the message becomes poisoned which will land in the default poison message queue (named &ldquo;EasyNetQ_Default_Error_Queue&rdquo;) The poison messages will contain the full stack trace of the exception that occurred. The messages can be re-processed using a command line tool named &ldquo;EasyNetQ.Hosepipe&rdquo; (<a href="https://github.com/EasyNetQ/EasyNetQ/wiki/Re-Submitting-Error-Messages-With-EasyNetQ.Hosepipe">https://github.com/EasyNetQ/EasyNetQ/wiki/Re-Submitting-Error-Messages-With-EasyNetQ.Hosepipe</a> )</p>
      <h2>Continuous Deployment Pipeline</h2>
      <p>The continuous deployment pipeline is comprised of sever tools working in concert.&nbsp;</p>
      <h3>TeamCity</h3>
      <p>The build system being use is TeamCity. We are using the free version which supports up to 20 build configuration. Currently, there are 3 build configurations for the AA application. One is for building the source code. The other is for triggering the deployment of the code after it is build. And the other configuration is used to execute smoke tests after the application has been deployed to all of the environments. Current the AA application is automatically deployed to three environments for every check-in on any branch.</p>
      <h4>Build -TeamCity</h4>
      <p>TeamCity will detect any new commit to the GitHub repository, and initiate a corresponding build for the respective branch. When the build completes (failure or success), TeamCity will send a status update to GitHub for the corresponding branch.&nbsp;</p>
      <h4>Source Control - GitHub</h4>
      <p>The source control system used is Git hosted on GitHub. When code is pushed to the GitHub repository, TeamCity will automatically detect the commit, and initiate a build. Every branch has a build status for the Build, Deployment, and Smoke tests. Any failure will update the branch status, and prevent and pull requests from being merged until the status for all three is passing.</p>
      <h4>Smoke tests</h4>
      <p>The final triggered build configuration is the smoke tests. These with execute integration type tests against the deployed produced to ensure that the application&rsquo;s basic functionality work properly. These tests are not comprehensive, but offer some level of confidence that the deployed product is working as expected.</p>
      <h3>Deployment &ndash; Build Master</h3>
      <p>The BuildMaster server is hosted on the same server as TeamCity. The BuildMaster deployment pipeline consists of several different stages. The first stage is to import the artifacts from TeamCity. Thesecond stage is to deploy the artifacts to the &ldquo;Integration&rdquo; environment (just the local BuildMaster server). The second stage is to deploy to SSUI &ldquo;Pre-Testing&rdquo; environment, which is the same servers as the SSUI development server, but the service ports are different to allow for side-by-side deployments. The third stage is the &ldquo;Testing&rdquo; or development environment, this is the final stage of the automated deployment. The next stage is &ldquo;Pre-Production&rdquo;, which is on the SSUI production server, but the services are installed to alternative ports or allow for side-by-side deployments. The final stage is production</p>
      <h3>Application Logs</h3>
      <p>All logging in the AA application is done using the NLog logging framework for .NET. There are two mains application logs, one for the WebAPI and one for the Audit Processor Service. The logs are stored in &ldquo;C:\AdvancedAudit\logs\AuditProcessorService\AuditProcessor.log.txt&rdquo; and &ldquo;C:\AdvancedAudit\logs\AuditProcessorService\AuditingApi.log.txt&rdquo;. The logs are rolled over when the size exceed a configurable limit (currently 1 MB). The verbosity of the logging can be controlled by modifying the &ldquo;NLog.config&rdquo; files found at &ldquo;</p>
      <h3>Database backups</h3>
      <p>Every deployment first makes a backup of the current production database. The backups are stored in "C:\AdvancedAudit\DBBackups&rdquo; and are timestamped like: "C:\AdvancedAudit\DBBackups\SSUIAdvancedAudit_2017-08-17_01-33-25.bak". The backups are kept on the respective SQL server for the given environment.</p>
      <h3>Installation location</h3>
      <p>The production websites are installed to "C:\inetpub\wwwroot\api.audit.ssui.local" and "C:\inetpub\wwwroot\api.audit.ssui.local ". The folder names for other deployment types will be slightly different depending on the environment.</p>
      <h3>Deployment archives</h3>
      <p>All of the previous deployed artifacts are archived before the new version is deployed. The archive location is:</p>
      <h2>Authentication and Authorization</h2>
      <p>Currently, the Advanced Audit application does not implement any authentication or authorization. For the near term, the plan is to add Windows authentication at the IIS level.&nbsp;</p>

    </body>
</html>